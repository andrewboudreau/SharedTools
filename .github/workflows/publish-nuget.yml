name: Publish NuGet Packages

on:
  push:
    branches: [ master ]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Start Azurite
      run: docker run -d -p 10000:10000 -p 10001:10001 -p 10002:10002 mcr.microsoft.com/azure-storage/azurite azurite --skipApiVersionCheck --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Compute next version
      id: version
      run: |
        # Find the latest v*.*.* tag by semantic version order
        LATEST_TAG=$(git tag --list 'v*.*.*' --sort=-version:refname | head -n 1)

        if [ -z "$LATEST_TAG" ]; then
          echo "No version tags found. Starting at 0.1.0"
          NEW_VERSION="0.1.0"
        else
          echo "Latest tag: $LATEST_TAG"
          CURRENT=${LATEST_TAG#v}
          MAJOR=$(echo "$CURRENT" | cut -d. -f1)
          MINOR=$(echo "$CURRENT" | cut -d. -f2)
          BUILD=$(echo "$CURRENT" | cut -d. -f3)
          BUILD=$((BUILD + 1))
          NEW_VERSION="$MAJOR.$MINOR.$BUILD"
        fi

        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "New version: v$NEW_VERSION"

    - name: Update csproj versions
      run: |
        VERSION=${{ steps.version.outputs.version }}
        echo "Updating csproj files to version $VERSION"

        sed -i "s/<Version>[0-9]\+\.[0-9]\+\.[0-9]\+/<Version>$VERSION/g" SharedTools.Web/SharedTools.Web.csproj
        sed -i "s/<Version>[0-9]\+\.[0-9]\+\.[0-9]\+/<Version>$VERSION/g" SharedTools.ModuleManagement/SharedTools.ModuleManagement.csproj

        echo "Updated versions:"
        grep -o "<Version>.*</Version>" SharedTools.Web/SharedTools.Web.csproj
        grep -o "<Version>.*</Version>" SharedTools.ModuleManagement/SharedTools.ModuleManagement.csproj

    - name: Restore dependencies
      run: dotnet restore --configfile nuget.ci.config

    - name: Build
      run: dotnet build --no-restore --configuration Release

    - name: Setup local NuGet feed for module tests
      run: |
        mkdir -p /tmp/local-nuget
        find . -path '*/bin/Release/*.nupkg' -exec cp {} /tmp/local-nuget/ \;
        cat > SharedTools.Tests/bin/Release/net10.0/nuget.config << 'NUGETEOF'
        <?xml version="1.0" encoding="utf-8"?>
        <configuration>
          <packageSources>
            <add key="local-test" value="/tmp/local-nuget" />
            <add key="nuget.org" value="https://api.nuget.org/v3/index.json" protocolVersion="3" />
          </packageSources>
        </configuration>
        NUGETEOF

    - name: Test
      run: dotnet test --no-build --configuration Release

    - name: Pack SharedTools.Web
      run: dotnet pack SharedTools.Web/SharedTools.Web.csproj --configuration Release --no-build --output nuget-packages

    - name: Pack SharedTools.ModuleManagement
      run: dotnet pack SharedTools.ModuleManagement/SharedTools.ModuleManagement.csproj --configuration Release --no-build --output nuget-packages

    - name: Create tag
      run: |
        git tag "v${{ steps.version.outputs.version }}"
        git push origin "v${{ steps.version.outputs.version }}"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: Release v${{ steps.version.outputs.version }}
        files: nuget-packages/*.nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Publish to NuGet
      run: |
        dotnet nuget push "./nuget-packages/*.nupkg" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate
